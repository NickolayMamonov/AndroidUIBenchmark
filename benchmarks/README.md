# UI Benchmark Framework

Фреймворк для измерения и сравнения производительности различных подходов к разработке UI в Android.

## Описание

Этот модуль предоставляет инструменты для измерения различных метрик производительности UI в Android-приложениях:

* Время инициализации UI (первая отрисовка)
* Использование памяти
* Время реакции на изменение данных
* Сложность кода (количество строк, цикломатическая сложность)
* Производительность при прокрутке списков
* Производительность при сложных анимациях

Бенчмарки предназначены для сравнения трех подходов к разработке UI:
* Jetpack Compose (`app-compose`)
* Традиционный XML-подход (`app-xml`)
* BDUI (Библиотека UI на основе данных, `app-bdui`)

## Структура

Проект организован следующим образом:

* `BenchmarkUtils.kt` - основные утилиты для запуска и измерения бенчмарков
* `StartupBenchmark.kt` - тесты времени инициализации UI
* `MemoryUsageBenchmark.kt` - тесты использования памяти
* `DataChangeResponseBenchmark.kt` - тесты скорости реакции на изменение данных
* `ScrollingPerformanceBenchmark.kt` - тесты производительности при прокрутке списков
* `AnimationPerformanceBenchmark.kt` - тесты производительности анимаций
* `CodeComplexityAnalyzer.kt` - анализатор сложности кода
* `CodeComplexityBenchmark.kt` - запуск анализа сложности кода
* `BenchmarkSummary.kt` - компиляция и форматирование результатов тестов
* `RunAllBenchmarksTest.kt` - запуск всех бенчмарков последовательно

## Запуск тестов

### Подготовка

1. Убедитесь, что все приложения (`app-compose`, `app-xml`, `app-bdui`) установлены на устройстве
2. Устройство должно быть подключено с включенным режимом разработчика и отладкой по USB

### Запуск отдельных бенчмарков

Вы можете запустить отдельные тесты через Android Studio:

1. Откройте файл с нужным тестом (например, `StartupBenchmark.kt`)
2. Нажмите на зеленый треугольник рядом с классом или методом теста
3. Выберите устройство для запуска

### Запуск всех бенчмарков

Для запуска всех бенчмарков последовательно:

```bash
./gradlew benchmarks:connectedBenchmarkAndroidTest
```

> **Внимание**: Запуск всех тестов занимает значительное время. Рекомендуется запускать тесты по отдельности.

## Интерпретация результатов

После запуска тестов результаты сохраняются в директории `sdcard/Android/data/{package_name}/files/` на устройстве. Основные результаты:

* `benchmark_summary.json` - полные данные бенчмарков в формате JSON
* `benchmark_summary.txt` - человекочитаемый отчет с ключевыми метриками
* `code_complexity_report.txt` - отчет по анализу сложности кода

Для извлечения результатов с устройства:

```bash
adb pull /sdcard/Android/data/com.research.uibenchmark.benchmarks/files/benchmark_summary.txt ./results/
```

## Добавление новых бенчмарков

### Для добавления нового типа бенчмарка:

1. Создайте новый класс, унаследованный от `BenchmarkRule`
2. Добавьте необходимые методы для тестирования
3. Используйте `BenchmarkUtils` для выполнения UI-операций
4. Обновите `RunAllBenchmarksTest` для включения нового бенчмарка
5. Обновите `BenchmarkSummary` для включения нового типа метрики в отчет

### Пример добавления нового теста:

```kotlin
@LargeTest
@RunWith(AndroidJUnit4::class)
class MyNewBenchmark {

    @get:Rule
    val benchmarkRule = BenchmarkRule()

    @Test
    fun composeNewFeatureTest() {
        val packageName = "com.research.uibenchmark.compose"
        
        benchmarkRule.measureUiMetric(
            metricType = UiMetricType.YOUR_NEW_METRIC_TYPE,
            packageName = packageName,
            setup = {
                // Код инициализации
            },
            testBlock = {
                // Код теста
            },
            teardown = {
                // Код очистки
            }
        )
    }
}
```

## Рекомендации по созданию надежных бенчмарков

1. **Избегайте внешних факторов**:
   - Запускайте тесты при постоянном уровне заряда батареи (предпочтительно подключенное к питанию устройство)
   - Закройте все фоновые приложения
   - Отключите переменную частоту процессора для получения стабильных результатов

2. **Повторение измерений**:
   - Каждый тест должен запускаться несколько раз для получения статистически значимых результатов
   - Используйте `measureRepeated` для автоматического повторения тестов

3. **Изоляция тестов**:
   - Между тестами убедитесь, что предыдущий тест не влияет на следующий
   - Используйте `pressHome()` для сброса состояния устройства между тестами

4. **Документирование результатов**:
   - Записывайте версию OS, модель устройства и другие релевантные параметры
   - Сравнивайте только метрики, полученные на одном и том же устройстве

## Ограничения и известные проблемы

- Для корректной работы бенчмарков необходимо, чтобы UI-элементы имели правильные IDs в разных реализациях
- Некоторые метрики (например, использование памяти) могут варьироваться в зависимости от состояния системы
- Трассировка методов может влиять на производительность тестируемого приложения
